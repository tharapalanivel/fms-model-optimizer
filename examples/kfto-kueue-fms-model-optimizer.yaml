# Example ConfigMap running GPTQ on Meta-Llama-3-8B on 2 GPUs
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
data:
  config.json: |
    {
      "model_name_or_path": "/models/Meta-Llama-3-8B",
      "training_data_path": "data_train",
      "quant_method": "gptq",
      "bits": 4,
      "group_size": 128,
      "output_dir": "/output/Meta-Llama-3-8B-GPTQ-MULTIGPU"
    }
---
apiVersion: "kubeflow.org/v1"
kind: PyTorchJob
metadata:
  name: kfto-fms-mo
  # This is using Kueue (https://github.com/kubernetes-sigs/kueue) for queue management
  # To enable, uncomment label below
  # labels:
  #   kueue.x-k8s.io/queue-name: lq-optimizer
spec:
  pytorchReplicaSpecs:
    Master:
      replicas: 1
      restartPolicy: Never # Do not restart the pod on failure. If you do set it to OnFailure, be sure to also set backoffLimit
      template:
        spec:
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: nvidia.com/gpu.product
                        operator: In
                        values:
                          - NVIDIA-A100-SXM4-80GB # a100 needed for flash-attn
          containers:
            - name: pytorch
              # Be sure to replace the image below
              image: $FMS_MO_IMAGE
              imagePullPolicy: IfNotPresent
              env:
                - name: FMS_MO_CONFIG_JSON_PATH
                  value: /etc/config/config.json
              volumeMounts:
              - name: config-volume
                mountPath: /etc/config
              - name: models
                mountPath: /data/models
              - name: input-data
                mountPath: /data/input
              - name: output-data
                mountPath: /data/output
              resources:
                limits:
                  # Number of GPUs specified will be number of processes set
                  nvidia.com/gpu: 2
                  memory: 50Gi
                  ephemeral-storage: 100Gi
          imagePullSecrets:
          - name: $MY_SECRET
          volumes:
          # PVC mounts will need to be updated depending on your cluster environment
          - name: models
            persistentVolumeClaim:
              claimName: model-pvc
          - name: input-data
            persistentVolumeClaim:
              claimName: cos-input
          - name: output-data
            persistentVolumeClaim:
              claimName: cos-output
          - name: config-volume
            configMap:
              name: my-config
              items:
              - key: config.json
                path: config.json
